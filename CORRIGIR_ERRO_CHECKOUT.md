# Correção Crítica do Banco de Dados (Erro ao Criar Pedido)

Você está recebendo o erro `invalid input syntax for type bigint: "..."` ao tentar finalizar uma compra. Isso acontece porque o código do site foi atualizado para usar **IDs seguros (UUID)**, mas o seu banco de dados ainda está esperando **IDs numéricos antigos**.

Para corrigir isso e permitir que o checkout funcione (inclusive para visitantes), você **PRECISA** rodar o script abaixo no Supabase.

## Passo a Passo:

1.  Acesse o painel do seu projeto no Supabase: [https://supabase.com/dashboard](https://supabase.com/dashboard)
2.  No menu lateral esquerdo, clique em **SQL Editor** (ícone de terminal `>_`).
3.  Clique em **+ New Query** (ou "New snippet").
4.  Copie e cole TODO o código SQL abaixo na área de edição.
5.  Clique no botão **Run** (verde) no canto inferior direito.

## Código SQL para Rodar:

```sql
-- 1. Primeiro, vamos limpar as tabelas para evitar conflitos de tipos
-- ATENÇÃO: Isso apagará os pedidos de teste existentes.
DROP TABLE IF EXISTS public.order_items CASCADE;
DROP TABLE IF EXISTS public.orders CASCADE;

-- 2. Recriar a tabela de PEDIDOS (orders) com ID do tipo UUID
CREATE TABLE public.orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- Agora usa UUID
    user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL, -- Pode ser nulo para Guest Checkout
    customer_name TEXT NOT NULL,
    customer_email TEXT NOT NULL,
    customer_phone TEXT NOT NULL,
    
    -- Endereço
    address_zip TEXT NOT NULL,
    address_street TEXT NOT NULL,
    address_number TEXT NOT NULL,
    address_complement TEXT,
    address_neighborhood TEXT NOT NULL,
    address_city TEXT NOT NULL,
    address_state TEXT NOT NULL,
    
    -- Valores e Status
    shipping_cost DECIMAL(10,2) NOT NULL DEFAULT 0,
    total_amount DECIMAL(10,2) NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending', -- pending, paid, shipped, delivered, cancelled
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 3. Recriar a tabela de ITENS DO PEDIDO (order_items)
CREATE TABLE public.order_items (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    order_id UUID REFERENCES public.orders(id) ON DELETE CASCADE NOT NULL, -- Referência UUID
    product_id BIGINT NOT NULL, -- Referência ao produto (que ainda é numérico)
    product_name TEXT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    quantity INTEGER NOT NULL,
    customization TEXT, -- Nome bordado, etc.
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 4. Configurar Permissões de Segurança (RLS)
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.order_items ENABLE ROW LEVEL SECURITY;

-- Permitir que qualquer pessoa (inclusive não logada) crie um pedido
CREATE POLICY "Enable insert for everyone" ON public.orders FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable insert for everyone" ON public.order_items FOR INSERT WITH CHECK (true);

-- Permitir que usuários vejam APENAS seus próprios pedidos (se logados)
CREATE POLICY "Users can view own orders" ON public.orders FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can view own order items" ON public.order_items FOR SELECT USING (
    EXISTS (
        SELECT 1 FROM public.orders WHERE orders.id = order_items.order_id AND orders.user_id = auth.uid()
    )
);

-- Permitir leitura pública de pedidos recém-criados (para página de sucesso)
-- Nota: Em produção real, seria ideal restringir isso via token, mas para MVP isso resolve o erro de "não ver o pedido" após criar.
CREATE POLICY "Enable read access for all users" ON public.orders FOR SELECT USING (true);
CREATE POLICY "Enable read access for all users" ON public.order_items FOR SELECT USING (true);
```

## Após rodar o script:
1.  Tente fazer uma compra novamente no site.
2.  O erro deve desaparecer e o pedido será criado com sucesso.
